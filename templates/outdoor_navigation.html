<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outdoor Navigation - Complete System</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #1a1a1a; color: #fff; 
            overflow-x: hidden;
        }
        .container { 
            display: flex; 
            height: 100vh; 
            gap: 12px; 
            padding: 12px; 
        }
        .left-panel { 
            width: 400px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
        }
        .right-panel { 
            flex: 1; 
            position: relative; 
        }
        .panel { 
            background: #2a2a2a; 
            border-radius: 12px; 
            padding: 16px; 
            border: 1px solid #444; 
        }
        .panel h3 { 
            margin-bottom: 12px; 
            color: #4CAF50; 
            font-size: 16px; 
        }
        .btn { 
            background: #4CAF50; 
            color: white; 
            border: none; 
            padding: 10px 16px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            margin: 4px; 
            transition: all 0.2s;
        }
        .btn:hover { background: #45a049; }
        .btn.secondary { background: #2196F3; }
        .btn.secondary:hover { background: #1976D2; }
        .btn.danger { background: #f44336; }
        .btn.danger:hover { background: #d32f2f; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #555; 
            border-radius: 6px; 
            background: #333; 
            color: #fff; 
            margin: 4px 0; 
        }
        .status { 
            padding: 8px; 
            border-radius: 6px; 
            margin: 8px 0; 
            font-size: 14px; 
        }
        .status.success { background: #2e7d32; }
        .status.error { background: #c62828; }
        .status.info { background: #1565c0; }
        .result-item { 
            background: #333; 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 8px; 
            border: 1px solid #555; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        .result-item:hover { 
            background: #444; 
            border-color: #4CAF50; 
        }
        .result-item.selected { 
            background: #1b5e20; 
            border-color: #4CAF50; 
        }
        .result-name { 
            font-weight: 600; 
            color: #4CAF50; 
            margin-bottom: 4px; 
        }
        .result-address { 
            font-size: 12px; 
            color: #ccc; 
            margin-bottom: 4px; 
        }
        .result-distance { 
            font-size: 12px; 
            color: #FF9800; 
        }
        #map { 
            height: 100%; 
            border-radius: 12px; 
            border: 1px solid #444; 
        }
        .controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin-top: 12px; 
        }
        .small { 
            font-size: 12px; 
            color: #aaa; 
        }
        .vision-panel { 
            background: #2a2a2a; 
            border: 2px solid #FF9800; 
            border-radius: 12px; 
            padding: 16px; 
            margin-top: 12px; 
        }
        .vision-panel h3 { 
            color: #FF9800; 
            margin-bottom: 12px; 
        }
        .vision-results { 
            background: #333; 
            padding: 12px; 
            border-radius: 8px; 
            margin: 8px 0; 
            font-size: 14px; 
        }
        .vision-hazards { 
            color: #f44336; 
            font-weight: 600; 
        }
        .vision-guidance { 
            color: #4CAF50; 
            font-weight: 600; 
        }
        .vision-direction { 
            color: #2196F3; 
            font-weight: 600; 
        }
        .unified-instruction { 
            background: #2a2a2a; 
            border: 2px solid #4CAF50; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 12px; 
        }
        .unified-instruction h3 { 
            color: #4CAF50; 
            margin-bottom: 12px; 
        }
        .instruction-text { 
            font-size: 16px; 
            font-weight: 600; 
            color: #fff; 
            margin-bottom: 8px; 
            min-height: 24px; 
        }
        .instruction-context { 
            font-size: 12px; 
            color: #FF9800; 
            margin-bottom: 4px; 
        }
        .instruction-distance { 
            font-size: 12px; 
            color: #4CAF50; 
        }
        .camera-container { 
            text-align: center; 
            margin: 12px 0; 
        }
        #videoElement { 
            width: 100%; 
            max-width: 300px; 
            border-radius: 8px; 
            border: 2px solid #444; 
        }
        #photoCanvas { 
            display: none; 
        }
        .search-results { 
            max-height: 300px; 
            overflow-y: auto; 
        }
        .navigation-status { 
            background: #2a2a2a; 
            border: 1px solid #444; 
            border-radius: 8px; 
            padding: 12px; 
            margin-bottom: 12px; 
        }
        .navigation-status.active { 
            border-color: #4CAF50; 
            background: #1b5e20; 
        }
        .navigation-status h4 { 
            color: #4CAF50; 
            margin-bottom: 8px; 
        }
        .route-info { 
            display: flex; 
            justify-content: space-between; 
            font-size: 12px; 
            color: #ccc; 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- System Status -->
            <div class="panel">
                <h3>üöÄ System Status</h3>
                <div id="systemStatus" class="status info">Initializing...</div>
                <div class="controls">
                    <button class="btn" onclick="startNavigationSystem()">üöÄ Start System</button>
                    <button class="btn secondary" onclick="checkSystemStatus()">üîç Check Status</button>
                </div>
            </div>

            <!-- Unified Smart Navigation -->
            <div class="unified-instruction">
                <h3>üéØ Smart Navigation</h3>
                <div class="instruction-context" id="instructionContext">-</div>
                <div class="instruction-text" id="unifiedInstruction">Ready for navigation...</div>
                <div class="instruction-distance" id="instructionDistance">-</div>
                <div class="controls">
                    <button class="btn" onclick="speakUnifiedInstruction()">üîä Speak</button>
                    <button class="btn secondary" onclick="forceInstructionUpdate()">üîÑ Update</button>
                </div>
            </div>

            <!-- Google Places Search -->
            <div class="panel">
                <h3>üîç Search Places</h3>
                <input type="text" id="searchInput" placeholder="Search for places..." onkeypress="handleSearchKeypress(event)">
                <div class="controls">
                    <button class="btn" onclick="searchPlaces()">üîç Search</button>
                    <button class="btn secondary" onclick="clearSearch()">üóëÔ∏è Clear</button>
                </div>
                <div id="searchStatus" class="status info" style="display:none;"></div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <!-- Navigation Control -->
            <div class="panel">
                <h3>üß≠ Navigation Control</h3>
                <div id="navigationStatus" class="navigation-status">
                    <h4>No Active Navigation</h4>
                    <div class="route-info">
                        <span>Distance: -</span>
                        <span>Time: -</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn" id="startNavBtn" onclick="startNavigation()" disabled>üöÄ Start Navigation</button>
                    <button class="btn danger" id="stopNavBtn" onclick="stopNavigation()" disabled>‚èπÔ∏è Stop</button>
                </div>
            </div>

            <!-- Vision Analysis -->
            <div class="vision-panel">
                <h3>üëÅÔ∏è Vision Analysis</h3>
                <div class="camera-container">
                    <video id="videoElement" autoplay muted style="display:none;"></video>
                    <canvas id="photoCanvas" width="640" height="480"></canvas>
                </div>
                <div class="controls">
                    <button class="btn" id="startCameraBtn" onclick="startCamera()">üì∑ Start Camera</button>
                    <button class="btn secondary" id="captureBtn" onclick="capturePhoto()" disabled>üì∏ Take Photo</button>
                    <button class="btn danger" id="stopCameraBtn" onclick="stopCamera()" disabled>‚èπÔ∏è Stop Camera</button>
                </div>
                <div id="visionStatus" class="status info" style="display:none;"></div>
                <div id="visionResults" class="vision-results" style="display:none;">
                    <div><strong>Guidance:</strong> <span id="visionGuidance">-</span></div>
                    <div><strong>Hazards:</strong> <span id="visionHazards" class="vision-hazards">-</span></div>
                    <div><strong>Direction:</strong> <span id="visionDirection" class="vision-direction">-</span></div>
                    <div><strong>Provider:</strong> <span id="visionProvider">-</span></div>
                </div>
            </div>

            <!-- Audio Controls -->
            <div class="panel">
                <h3>üîä Audio Controls</h3>
                <div class="controls">
                    <button class="btn" onclick="testTTS()">üîä Test TTS</button>
                    <button class="btn secondary" onclick="clearAudioQueue()">üóëÔ∏è Clear Audio</button>
                </div>
                <div class="small" style="margin-top: 8px;">
                    Audio Queue: <span id="audioQueueStatus">Empty</span>
                </div>
            </div>
        </div>

        <!-- Right Panel - Map -->
        <div class="right-panel">
            <div id="map"></div>
        </div>
    </div>

    <script>
        // Global variables
        let map, meMarker, routeLayer, currentSessionId = null;
        let selectedPlace = null;
        let isNavigating = false;
        let isVisionEnabled = false;
        let videoStream = null;
        
        // Timers
        let unifiedTimer = null;
        let locationTimer = null;
        
        // Audio management
        let currentAudio = null;
        let audioQueue = [];
        let isPlaying = false;
        let lastTTSInstruction = '';
        let ttsCooldown = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            startNavigationSystem();
        });

        // Map initialization
        function initMap() {
            try {
                map = L.map('map').setView([25.2048, 55.2708], 13); // Dubai center
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
                
                // Add user location marker
                meMarker = L.marker([25.2048, 55.2708], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background: #4CAF50; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);
                
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Map initialization error:', error);
                setSystemStatus('Map initialization failed', 'error');
            }
        }

        // Start navigation system
        async function startNavigationSystem() {
            try {
                setSystemStatus('Starting navigation system...', 'info');
                
                const response = await fetch('/api/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    currentSessionId = data.session_id;
                    setSystemStatus('Navigation system started successfully', 'success');
                    
                    // Start location updates
                    startLocationUpdates();
                    
                    // Start unified instruction updates
                    startUnifiedInstructionUpdates();
                    
                    // Enable navigation button
                    document.getElementById('startNavBtn').disabled = false;
                } else {
                    setSystemStatus('Failed to start navigation system: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Navigation system start error:', error);
                setSystemStatus('Navigation system start failed', 'error');
            }
        }

        // Check system status
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/status', {
                    credentials: 'include',
                    headers: currentSessionId ? {'X-Client-ID': currentSessionId} : {}
                });
                
                const data = await response.json();
                console.log('System status:', data);
                
                if (data.success) {
                    setSystemStatus(`System active - Session: ${data.session_id}`, 'success');
                } else {
                    setSystemStatus('System not active', 'error');
                }
            } catch (error) {
                console.error('Status check error:', error);
                setSystemStatus('Status check failed', 'error');
            }
        }

        // Start location updates
        function startLocationUpdates() {
            if (locationTimer) clearInterval(locationTimer);
            
            locationTimer = setInterval(async () => {
                try {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(async (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            // Update map marker
                            if (meMarker) {
                                meMarker.setLatLng([lat, lng]);
                                map.setView([lat, lng], map.getZoom());
                            }
                            
                            // Update server location
                            await fetch('/api/location', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                credentials: 'include',
                                body: JSON.stringify({lat, lng})
                            });
                        });
                    }
                } catch (error) {
                    console.error('Location update error:', error);
                }
            }, 5000);
        }

        // Start unified instruction updates
        function startUnifiedInstructionUpdates() {
            if (unifiedTimer) clearInterval(unifiedTimer);
            
            unifiedTimer = setInterval(updateUnifiedInstruction, 4000);
        }

        // Update unified instruction
        async function updateUnifiedInstruction() {
            try {
                if (!currentSessionId) return;
                
                const response = await fetch('/api/navigation/unified-instruction', {
                    credentials: 'include',
                    headers: {'X-Client-ID': currentSessionId}
                });
                
                const data = await response.json();
                
                if (data && data.success && data.instruction) {
                    // Update display
                    document.getElementById('unifiedInstruction').textContent = data.instruction;
                    document.getElementById('instructionContext').textContent = data.context || '-';
                    document.getElementById('instructionDistance').textContent = 
                        data.distance ? `Distance: ${Math.round(data.distance)}m ‚Ä¢ Time: ${Math.round(data.duration/60)}min` : '-';
                    
                    // Speak instruction if different
                    if (data.instruction !== lastTTSInstruction && !ttsCooldown) {
                        lastTTSInstruction = data.instruction;
                        ttsCooldown = true;
                        await speakText(data.instruction);
                        setTimeout(() => { ttsCooldown = false; }, 3000);
                    }
                }
            } catch (error) {
                console.error('Unified instruction update error:', error);
            }
        }

        // Search places
        async function searchPlaces() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                setSearchStatus('Enter a search query', 'error');
                return;
            }
            
            try {
                setSearchStatus('Searching...', 'info');
                
                const searchParams = {
                    query: query,
                    location: meMarker ? {lat: meMarker.getLatLng().lat, lng: meMarker.getLatLng().lng} : null,
                    radius: 15000
                };
                
                const response = await fetch('/api/google/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify(searchParams)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    renderSearchResults(data.results || []);
                    setSearchStatus(`Found ${data.results.length} results`, 'success');
                } else {
                    setSearchStatus('Search failed: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Search error:', error);
                setSearchStatus('Search failed', 'error');
            }
        }

        // Render search results
        function renderSearchResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';
            
            results.forEach((place, index) => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.onclick = () => selectPlace(place, div);
                
                div.innerHTML = `
                    <div class="result-name">${place.name}</div>
                    <div class="result-address">${place.address}</div>
                    <div class="result-distance">${place.distance ? place.distance + ' km away' : ''}</div>
                `;
                
                container.appendChild(div);
            });
        }

        // Select place
        function selectPlace(place, element) {
            // Remove previous selection
            document.querySelectorAll('.result-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Select current place
            element.classList.add('selected');
            selectedPlace = place;
            
            // Enable navigation button
            document.getElementById('startNavBtn').disabled = false;
            
            // Add marker to map
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            const placeMarker = L.marker([place.location.lat, place.location.lng], {
                icon: L.divIcon({
                    className: 'place-marker',
                    html: '<div style="background: #2196F3; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                })
            }).addTo(map);
            
            routeLayer = L.layerGroup([placeMarker]);
        }

        // Start navigation
        async function startNavigation() {
            if (!selectedPlace) {
                setSystemStatus('Please select a destination first', 'error');
                return;
            }
            
            try {
                setSystemStatus('Starting navigation...', 'info');
                
                const response = await fetch('/api/google/navigate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        place_id: selectedPlace.place_id,
                        name: selectedPlace.name,
                        location: selectedPlace.location
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    isNavigating = true;
                    setSystemStatus('Navigation started successfully', 'success');
                    
                    // Update navigation status
                    document.getElementById('navigationStatus').classList.add('active');
                    document.getElementById('navigationStatus').innerHTML = `
                        <h4>Navigating to ${selectedPlace.name}</h4>
                        <div class="route-info">
                            <span>Distance: ${data.distance || '-'}</span>
                            <span>Time: ${data.duration || '-'}</span>
                        </div>
                    `;
                    
                    // Update buttons
                    document.getElementById('startNavBtn').disabled = true;
                    document.getElementById('stopNavBtn').disabled = false;
                    
                    // Start instruction updates
                    updateUnifiedInstruction();
                } else {
                    setSystemStatus('Navigation failed: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Navigation start error:', error);
                setSystemStatus('Navigation start failed', 'error');
            }
        }

        // Stop navigation
        async function stopNavigation() {
            try {
                setSystemStatus('Stopping navigation...', 'info');
                
                // Clear route from map
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                    routeLayer = null;
                }
                
                // Reset state
                isNavigating = false;
                selectedPlace = null;
                
                // Update UI
                document.getElementById('navigationStatus').classList.remove('active');
                document.getElementById('navigationStatus').innerHTML = `
                    <h4>No Active Navigation</h4>
                    <div class="route-info">
                        <span>Distance: -</span>
                        <span>Time: -</span>
                    </div>
                `;
                
                document.getElementById('startNavBtn').disabled = true;
                document.getElementById('stopNavBtn').disabled = true;
                
                // Clear search selection
                document.querySelectorAll('.result-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                setSystemStatus('Navigation stopped', 'success');
            } catch (error) {
                console.error('Navigation stop error:', error);
                setSystemStatus('Navigation stop failed', 'error');
            }
        }

        // Camera functions
        async function startCamera() {
            try {
                setVisionStatus('Starting camera...', 'info');
                
                // Enable vision system
                await fetch('/api/vision/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({enabled: true})
                });
                
                // Start camera
                videoStream = await navigator.mediaDevices.getUserMedia({video: true});
                const video = document.getElementById('videoElement');
                video.srcObject = videoStream;
                video.style.display = 'block';
                
                isVisionEnabled = true;
                setVisionStatus('Camera started', 'success');
                
                // Update buttons
                document.getElementById('startCameraBtn').disabled = true;
                document.getElementById('captureBtn').disabled = false;
                document.getElementById('stopCameraBtn').disabled = false;
            } catch (error) {
                console.error('Camera start error:', error);
                setVisionStatus('Camera start failed', 'error');
            }
        }

        async function capturePhoto() {
            try {
                setVisionStatus('Capturing photo...', 'info');
                
                const video = document.getElementById('videoElement');
                const canvas = document.getElementById('photoCanvas');
                const ctx = canvas.getContext('2d');
                
                // Draw video frame to canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convert to blob
                canvas.toBlob(async (blob) => {
                    const formData = new FormData();
                    formData.append('image', blob, 'photo.jpg');
                    
                    const response = await fetch('/api/vision/frame', {
                        method: 'POST',
                        credentials: 'include',
                        body: formData
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        displayVisionResults(data);
                        setVisionStatus('Photo analyzed successfully', 'success');
                        
                        // Trigger unified instruction update
                        setTimeout(() => {
                            updateUnifiedInstruction();
                        }, 500);
                    } else {
                        setVisionStatus('Photo analysis failed: ' + data.message, 'error');
                    }
                }, 'image/jpeg', 0.8);
            } catch (error) {
                console.error('Photo capture error:', error);
                setVisionStatus('Photo capture failed', 'error');
            }
        }

        async function stopCamera() {
            try {
                setVisionStatus('Stopping camera...', 'info');
                
                // Disable vision system
                await fetch('/api/vision/toggle', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({enabled: false})
                });
                
                // Stop camera
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                    videoStream = null;
                }
                
                const video = document.getElementById('videoElement');
                video.style.display = 'none';
                video.srcObject = null;
                
                isVisionEnabled = false;
                setVisionStatus('Camera stopped', 'success');
                
                // Update buttons
                document.getElementById('startCameraBtn').disabled = false;
                document.getElementById('captureBtn').disabled = true;
                document.getElementById('stopCameraBtn').disabled = true;
                
                // Hide vision results
                document.getElementById('visionResults').style.display = 'none';
            } catch (error) {
                console.error('Camera stop error:', error);
                setVisionStatus('Camera stop failed', 'error');
            }
        }

        // Display vision results
        function displayVisionResults(data) {
            document.getElementById('visionGuidance').textContent = data.narration || '-';
            document.getElementById('visionHazards').textContent = data.hazards ? data.hazards.join(', ') : 'None';
            document.getElementById('visionDirection').textContent = data.suggested_heading || '-';
            document.getElementById('visionProvider').textContent = data.provider || '-';
            
            document.getElementById('visionResults').style.display = 'block';
        }

        // TTS functions
        async function speakText(text) {
            if (!text || isPlaying) return;
            
            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({text: text})
                });
                
                const data = await response.json();
                
                if (data.success && data.audio_url) {
                    // Stop current audio
                    if (currentAudio) {
                        currentAudio.pause();
                        currentAudio = null;
                    }
                    
                    // Play new audio
                    currentAudio = new Audio(data.audio_url);
                    isPlaying = true;
                    updateAudioQueueStatus();
                    
                    currentAudio.onended = () => {
                        isPlaying = false;
                        currentAudio = null;
                        updateAudioQueueStatus();
                        processAudioQueue();
                    };
                    
                    currentAudio.onerror = () => {
                        isPlaying = false;
                        currentAudio = null;
                        updateAudioQueueStatus();
                        processAudioQueue();
                    };
                    
                    await currentAudio.play();
                }
            } catch (error) {
                console.error('TTS error:', error);
                isPlaying = false;
                updateAudioQueueStatus();
            }
        }

        function processAudioQueue() {
            if (audioQueue.length > 0 && !isPlaying) {
                const nextText = audioQueue.shift();
                speakText(nextText);
            }
        }

        function clearAudioQueue() {
            audioQueue = [];
            if (currentAudio) {
                currentAudio.pause();
                currentAudio = null;
            }
            isPlaying = false;
            updateAudioQueueStatus();
        }

        function updateAudioQueueStatus() {
            document.getElementById('audioQueueStatus').textContent = 
                isPlaying ? 'Playing' : (audioQueue.length > 0 ? `${audioQueue.length} queued` : 'Empty');
        }

        // Utility functions
        function setSystemStatus(message, type) {
            const status = document.getElementById('systemStatus');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function setSearchStatus(message, type) {
            const status = document.getElementById('searchStatus');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function setVisionStatus(message, type) {
            const status = document.getElementById('visionStatus');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }

        function speakUnifiedInstruction() {
            const instruction = document.getElementById('unifiedInstruction').textContent;
            if (instruction && instruction !== 'Ready for navigation...') {
                speakText(instruction);
            }
        }

        function forceInstructionUpdate() {
            updateUnifiedInstruction();
        }

        function testTTS() {
            speakText('TTS test successful. Audio system is working properly.');
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('searchStatus').style.display = 'none';
            selectedPlace = null;
            document.getElementById('startNavBtn').disabled = true;
        }

        function handleSearchKeypress(event) {
            if (event.key === 'Enter') {
                searchPlaces();
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unifiedTimer) clearInterval(unifiedTimer);
            if (locationTimer) clearInterval(locationTimer);
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
